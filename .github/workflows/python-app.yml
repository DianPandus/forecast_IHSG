name: IHSG Forecast - Docker CI

on:
  workflow_dispatch: {}
  push:
    branches: [main]
    paths:
      - "Model.ipynb"
      - "Model.py"
      - "requirements.txt"
      - "Dockerfile"
      - ".github/workflows/**"
  # Jalan otomatis tiap 08:00 WIB (01:00 UTC)
  schedule:
    - cron: "0 1 * * *"

permissions:
  contents: write

concurrency:
  group: ci-notebook
  cancel-in-progress: true

jobs:
  build-run-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase true
          git config --global safe.directory "$GITHUB_WORKSPACE"

      - name: Build Docker image
        run: |
          # Jika Dockerfile bukan di root, ganti ke: docker build -t ihsg-forecast:latest -f path/ke/Dockerfile .
          docker build -t ihsg-forecast:latest .

      - name: Execute notebook inside container
        run: |
          docker run --rm \
            -v "$GITHUB_WORKSPACE":/app \
            -w /app \
            -e CUDA_VISIBLE_DEVICES= \
            -e TF_CPP_MIN_LOG_LEVEL=2 \
            -e TF_ENABLE_ONEDNN_OPTS=0 \
            ihsg-forecast:latest \
            jupyter nbconvert --to notebook --execute --inplace Model.ipynb

      - name: Stage outputs
        run: |
          # Tambah file output spesifik biar rapih; gunakan -A kalau perlu semuanya
          git add Model.ipynb || true
          if [ -f prediksi_terbaru_rf.csv ]; then git add prediksi_terbaru_rf.csv; fi

      - name: Commit if changes exist
        run: |
          if ! git diff --staged --quiet; then
            git commit -m "Update hasil prediksi terbaru"
          else
            echo "No changes to commit."
          fi

      - name: Rebase onto latest main
        run: |
          git fetch origin main
          git rebase origin/main || (echo "Rebase gagal; coba FF-only" && git rebase --abort && git pull --no-rebase --ff-only origin main)

      - name: Push to main (with retry)
        run: |
          (git push origin HEAD:main) || (
            echo "Push ditolak; fetch+rebase ulang lalu push..."
            git fetch origin main
            git rebase origin/main
            git push origin HEAD:main
          )
